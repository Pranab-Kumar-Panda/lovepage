<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arya - Your Social Coach</title>
    <style>
        :root {
            --primary-color: #bb86fc;
            --secondary-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #3700b3;
            --user-bubble-color: #332d41;
            --ai-bubble-color: #212121;
            --audio-btn-color: #bb86fc;
            --animation-duration: 0.3s;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--secondary-color);
            flex-direction: column;
            color: var(--text-color);
            padding: 20px;
            box-sizing: border-box;
        }

        #chat-container {
            width: 90%;
            max-width: 650px;
            background: #1e1e1e;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            height: 75vh;
            max-height: 850px;
            overflow: hidden;
        }

        #nav-bar {
            background-color: #2c2c2c;
            padding: 15px 20px;
            border-bottom: 1px solid #424242;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #nav-bar h1 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--primary-color);
            letter-spacing: 2px;
            white-space: nowrap;
            overflow: hidden;
            border-right: 2px solid var(--primary-color);
            animation:
                typing 2s steps(40, end) forwards,
                blink-caret 0.75s step-end infinite;
            width: 0;
        }

        @keyframes typing {
            from {
                width: 0;
            }
            to {
                width: 100%;
            }
        }

        @keyframes blink-caret {
            from, to {
                border-color: transparent;
            }
            50% {
                border-color: var(--primary-color);
            }
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        #messages::-webkit-scrollbar {
            width: 6px;
        }

        #messages::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 10px;
            border: 2px solid var(--secondary-color);
        }

        .message {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            transition: all var(--animation-duration) ease-in-out;
            display: flex;
            align-items: flex-end;
            font-size: 1rem;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn var(--animation-duration) ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
            background: var(--user-bubble-color);
            color: var(--text-color);
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background: var(--ai-bubble-color);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .message-text {
            flex-grow: 1;
        }

        .audio-btn {
            margin-left: 10px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--audio-btn-color);
            font-size: 1.1em;
            padding: 0;
            outline: none;
            flex-shrink: 0;
            transition: color var(--animation-duration) ease;
        }

        .audio-btn:hover {
            color: var(--primary-color);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            align-self: flex-start;
            background-color: var(--ai-bubble-color);
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
            position: relative;
            animation: fadeIn var(--animation-duration) ease-out forwards;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            margin: 0 2px;
            background-color: #888;
            border-radius: 50%;
            opacity: 0;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        #chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #424242;
            background: #1e1e1e;
        }

        #input-message {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #424242;
            background: #2c2c2c;
            color: var(--text-color);
            border-radius: 24px;
            font-size: 1rem;
            transition: border-color var(--animation-duration) ease, box-shadow var(--animation-duration) ease;
            outline: none;
        }

        #input-message::placeholder {
            color: #888;
        }

        #input-message:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(187, 134, 252, 0.25);
        }

        #chat-input button {
            padding: 12px 25px;
            margin-left: 10px;
            background: var(--primary-color);
            color: #121212;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color var(--animation-duration) ease;
            outline: none;
        }

        #chat-input button:hover {
            background: var(--accent-color);
        }

        #chat-input button:active {
            background: #a45df0;
        }

        .sending {
            animation: sendingAnimation var(--animation-duration) ease-in-out;
        }

        @keyframes sendingAnimation {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }

            #chat-container {
                width: 100%;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }

            #nav-bar {
                padding: 10px 15px;
            }

            #nav-bar h1 {
                font-size: 1.1rem;
            }

            .message {
                max-width: 90%;
                font-size: 0.9rem;
                padding: 8px 12px;
                border-radius: 16px;
            }

            .typing-indicator {
                padding: 8px 12px;
                border-radius: 16px;
            }

            #chat-input {
                padding: 10px;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #1e1e1e;
                z-index: 100;
                /* This is the key fix for the keyboard issue */
                padding-bottom: env(safe-area-inset-bottom);
                height: auto;
            }
            
            #messages {
                padding-bottom: 75px;
            }
        }
    </style>
    <script src="https://js.puter.com/v2/"></script>
</head>

<body>
    <div id="chat-container">
        <div id="nav-bar">
            <h1>Arya</h1>
        </div>
        <div id="messages"></div>
        <div id="chat-input">
            <input type="text" id="input-message" placeholder="Aap kaise ho? Start a conversation..." autocomplete="off">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        const messagesDiv = document.getElementById("messages");
        const inputMessage = document.getElementById("input-message");
        const sendButton = document.getElementById("send-button");
        let typingIndicator;
        
        // This is a new variable to store the SpeechSynthesisUtterance object
        let speechSynth = window.speechSynthesis;

        const messages = [{
            role: 'system',
            content: 'Your name is Arya. You were created by a developer named guruji. Your primary purpose is to help users learn conversational skills, public speaking, and confidence. Use emojis to make your advice friendly and easy to understand. When asked "What is your name?" respond with "Mera naam Arya hai." When asked "Who made you?" or "Who is your creator?" respond with "Mujhe guruji ne banaya hai." For all other questions, focus on your role as a social coach. Keep your tone encouraging and positive.'
        }];

        inputMessage.addEventListener("keyup", function(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        });
        sendButton.addEventListener("click", sendMessage);

        function showTypingIndicator() {
            typingIndicator = document.createElement("div");
            typingIndicator.classList.add("typing-indicator");
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            messagesDiv.appendChild(typingIndicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function removeTypingIndicator() {
            if (typingIndicator) {
                typingIndicator.remove();
                typingIndicator = null;
            }
        }

        function addMessage(msg, isUser) {
            const messageContainer = document.createElement("div");
            messageContainer.classList.add("message");
            messageContainer.classList.add(isUser ? "user-message" : "ai-message");

            const messageTextSpan = document.createElement("span");
            messageTextSpan.classList.add("message-text");
            messageContainer.appendChild(messageTextSpan);

            if (!isUser) {
                const audioButton = document.createElement("button");
                audioButton.innerHTML = '&#9658;';
                audioButton.classList.add("audio-btn");
                audioButton.onclick = () => playAudio(msg);
                messageContainer.appendChild(audioButton);
            }

            messagesDiv.appendChild(messageContainer);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            if (!isUser) {
                typeWriter(msg, messageTextSpan);
            } else {
                messageTextSpan.textContent = msg;
            }
        }

        function typeWriter(text, element, speed = 25) {
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    setTimeout(type, speed);
                }
            }
            type();
        }

        // Updated playAudio function for better reliability
        function playAudio(text) {
            if (speechSynth.speaking) {
                speechSynth.cancel();
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'hi-IN';
            utterance.rate = 1;
            speechSynth.speak(utterance);
        }

        function sendMessage() {
            const message = inputMessage.value.trim();
            if (message) {
                addMessage(message, true);
                inputMessage.value = '';
                inputMessage.focus();
                sendButton.classList.add("sending");
                setTimeout(() => {
                    sendButton.classList.remove("sending");
                }, 300);

                messages.push({
                    content: message,
                    role: 'user'
                });

                showTypingIndicator();

                puter.ai.chat(messages).then(response => {
                    removeTypingIndicator();
                    addMessage(response.message.content, false);
                    messages.push(response.message);
                }).catch(error => {
                    removeTypingIndicator();
                    console.error("AI response error:", error);
                    addMessage("Sorry, I'm having trouble connecting right now. Please try again.", false);
                });
            }
        }
    </script>
</body>

</html>
